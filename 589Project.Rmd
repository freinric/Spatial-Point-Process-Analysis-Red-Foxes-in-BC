---
title: "Red Foxes in BC: an Analysis of the Spatial Point Process"
author: "Nowshaba Durrani, Ricky Heinrich, Viji Rajagopalan"
date: "2023-04-09"
output: pdf_document
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F,fig.width=8, fig.height=6, warning = F, cache = T, message = F)
```


```{r message=FALSE, include=F}
library(rgbif) #allows searching and retrieving data from GBIF
library(ggplot2) #use ggplot2 to add layer for visualization
library(sp) #Standardized Support for Spatial Vector Data
library(sf)
library(spatstat)
library(maptools)
#library(raster)
#library(mapcan)
#library(bcmaps)
#library(tidyverse)
#library(rgdal)
```

# Introduction

```{r}
#occ_count() # occurance count for all the species in GBIF (Global Biodiversity Information Facility) - rgbif

redFox <- name_backbone(name="Vulpes vulpes")
redFoxList <- occ_data(taxonKey = redFox$speciesKey, hasCoordinate=TRUE, stateProvince='British Columbia', limit=2000)
mydata <- redFoxList$data
n_row <- nrow(redFoxList$data)
n_col <- ncol(redFoxList$data)
#n_row
#n_col
```



```{r}

load("BC_Covariates.Rda")

# Create a spatial points data frame from the longitude and latitude columns
coordinates <- mydata[,c("decimalLongitude", "decimalLatitude")]
dat.sp <- SpatialPointsDataFrame(c(mydata[,c('decimalLongitude','decimalLatitude')]), data = mydata)

# Set the current CRS
proj4string(dat.sp)<- CRS("+proj=longlat +datum=WGS84")

# Define the new CRS you want to transform to
new_crs <- CRS("+proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 
               +y_0=0 +datum=NAD83 +units=m +no_defs")

# Transform the data to the new CRS
data.sp_trans <- spTransform(dat.sp, new_crs)

#data_transformed
#data.sp_trans

#plot(data.sp_trans, main = "Locations in BC", cex = 0.8, col ="blue")
```

For our Data 589 project, we have selected Red Fox (Scientific Name - Vulpes Vulpes) to do the analysis. In the GBIF database they have approximately, 610,958+ georeferences records for this species around the world, however for this project we have selected to do the analysis of the occurance of Red Fox in BC only. So with the above function we have fetched the information for British Columbia only in `r n_col` columns and `r n_row` number of entries.

```{r warning=FALSE, fig.cap = "Occurence of Red Foxes in BC"}
parks_ppp <- ppp(x = data.sp_trans@coords[,1], # X coordinates
                    y = data.sp_trans@coords[,2], # Y coordinates
                    window = as.owin( DATA[["Window"]]),# Observation window
                    )

col_pal <- c("maroon")
plot(parks_ppp,
     main = "",
     cex = 0.9,
     col ="white",
     border = 3,
     cols = col_pal,
     par(bg = "grey90",cex.main = 1.6))

```

Here we have plotted all the occurrences of Red Fox in the BC region and we can see that the species are scattered in the region specially in the upper and middle part of the province. Now we will be exploring what is contributing to the occurrences of the species in the specific places based on various factors like elevation, close to water bodies, forests, human habitats, etc.

# Methods

Briefly describe the data and what variables are included. Provide a detailed description of the analytical workflow that was applied to the data, citing any relevant literature and statistical packages employed. There should be enough information that anyone can reproduce the workflow if they had access to the data. Length: As long as necessary.

The data comes from the Global Biodiversity Information Facility (GBIF) databases. We used the package `rgbif` to access the 'Vulpes Vulpes' data from R directly, sorting by instances occuring in BC. We've extracted the longitude and latitude data from this, and converted it appropriately using the `sp` package. 

Our second source of data contained the BC Window object, as well as possible covariate data: elevation, forest cover, Human Footprint Index (HFI) and distance to water.

We used the package `spatstat` to build a `ppp` object with the converted coordinates of the Red Fox locations from the GBIF data and the window from our second data source. 

To conduct first moment analysis, we used functions from the aforementioned `spatstat` package. We did a quadrat test as well as hotspot analysis to gain insight into the homogeneity assumption of the point process.

For second moment analysis, we looked into Ripley's K-function and pair correlation function using functions from `spatstat`. This provides us with insight into possible clustering tendencies of the point process.

Next we looked into the relationship of the intensity with each covariate. 


## First Moment Analysis

### Quadratcount
We start with investigating whether the occurence of red foxes in BC seems homogeneous, as it will inform our steps to define the intensity. We have conducted a quadrat test of homogeneity with both 5 x 5 and 10 x 10 quadrats. These quadrats are shown in Figure 2, where we can visually tell that the intensity in each quadrats are not the same. The quadrat test for both the 5 x 5 and the 10 x 10 quadrats provide a p-value of 2.2e-16, confirming that the varied intensities are not due to chance alone, but rather due to an inhomogeneous point process. 


```{r}
#Split into a 5 by 5 quadrat and count points
Q5 <- quadratcount(parks_ppp,
                  nx = 5,
                  ny = 5)

Q10 <- quadratcount(parks_ppp,
                  nx = 10,
                  ny = 10)
```

```{r, fig.cap = "Quadrat counts of Red Fox occurences, left 5x5, right 10x10", eval=F}

#Plot the output 
par(mfrow=c(1,2))
plot(parks_ppp,
     pch = 12,
     cex = 0.5,
     cols = "#046C9A",
     main = "")
plot(Q5, cex = 1, col = "red", add = T)
plot(parks_ppp,
     pch = 12,
     cex = 0.5,
     cols = "#046C9A",
     main = "")
plot(Q10, cex = 1, col = "red", add = T)
```

```{r, fig.cap = "Intensity of Quadrat counts of Red Fox occurences, left 5x5, right 10x10"}
#Plot the output 
par(mfrow=c(1,2))
plot(intensity(Q5, image = T),
     main = "")
plot(parks_ppp,
     pch = 12,
     cex = 0.5,
     cols = "#046C9A", add = T)
plot(intensity(Q10, image = T), main = "" )
plot(parks_ppp,
     pch = 12,
     cex = 0.5,
     cols = "#046C9A",
     add = T)
```


```{r warning=FALSE, eval=F}
#Quadrat test of homogeneity 
quadrat.test(Q10)
```


### Hot spot analysis

As the next step, we investigate analyze for any hot spots in the occurences of red foxes. In Figure 3, we can see that hotspots appear scattered around the province.

```{r fig.cap = "Hotspot of Red Foxes"}
# Estimate R
R <- bw.ppl(parks_ppp)

#Calculate test statistic
LR <- scanLRTS(parks_ppp, r = R)

#Plot the output 
plot(LR, main = "")
plot(parks_ppp[["window"]], border = "white", add = T)

#Compute local p-values
pvals <- eval.im(pchisq(LR,
                        df = 1,
                        lower.tail = FALSE))

#Plot the output
#plot(pvals, main = "Local p-values")
#plot(parks_ppp[["window"]],  add = T)
```


## 2nd Moment Analysis

### Ripley's K function
Ripley's K-function provides information on whether there are significant deviations from independence between points. Taking into account that the intensity of red fox occurences appear inhomogeneous, we can see in Figure 4 that there is some evidence of clustering up to a certain distance, as the black line, indicating the observed data, is separate from the 95% confidence bands of the values expected with no clustering. This suggests that the relationship between points may be due to effects between points rather than relationship with covariates. [CHECK THIS CLAIM ?] 


```{r fig.cap="Ripley's K function with border correction assuming homogeneity", eval=F}
E_fox_homo <- envelope(parks_ppp,
                  Kest,
                  correction="border",
                  rank = 1,
                  nsim = 19, # aka alpha of 0.05
                  fix.n = T,
                  verbose = F)
plot(E_fox_homo, lwd = 2, main = "")

# Assuming homogeneity in the point process, we see that the actual occurence lines appear clustered, as the black line does not overlap with the expected red line confidence intervals (significance level of 0.05).
```



```{r fig.cap="Ripley's K function with border correction assuming inhomogeneity"}
E_fox <- envelope(parks_ppp,
                  Kinhom,
                  correction="border",
                  rank = 1,
                  nsim = 19, # aka alpha of 0.05
                  fix.n = T,
                  verbose = F)
plot(E_fox, lwd = 2, main = "")
```



### Pair correlation function

To get a sense of the distances for which clustering occurs, we used the pair correlation function. Figure 5 shows evidence for clustering at distances smaller than around 23 000m, or 23km but after that the observed values are not significantly different that those expected from a random spatial process.


```{r fig.cap="Pair correlation function assuming inhomogeneity"}
# Estimate the g function
#pcf_fox <- pcfinhom(parks_ppp) # assumes inhomogeneity

# estimate a strickly pos density
lambda_pos <- density(parks_ppp,sigma=bw.ppl,positive=TRUE)
# estimating with bootstraped ci
pcf_fox <- envelope(parks_ppp, pcfinhom, simulate = expression(rpoispp(lambda_pos)),rank = 1, nsim = 19)
# Default plot method
#plot(pcf_fox, lwd = 2)

# visualise the results
plot(pcf_fox, main = "")
#plot(pcf_fox,theo ~ r,ylim = c(0,20),main = "",col = "grey70",lwd = 2,lty = "dashed")
#plot(pcf_fox,iso ~ r, col = c("#046C9A"),lwd = 2, add = T)
```


## Relationship with Covariates 
Our data includes 4 covariates we can explore: the elevation, the forest cover, the human footprint inventory (HFI), and the distance to water. Given our research questions, we will start with investigating the HFI and the forest cover.

### HFI
```{r, warning=F}
plot(DATA$HFI, box = F, par(cex.main = 2), main = "Forest")
plot(parks_ppp, pch = 16, cex = 0.9, col = "green",use.marks = F, add = T)
```

```{r}
rho_HFI <- rhohat(parks_ppp, DATA$HFI)

par(mfrow = c(1,2))
plot(rho_HFI,
     main = "",
     xlab = "HFI")
plot(rho_HFI,
     main = "",
     xlab = "HFI", xlim = c(0,0.4))
```



In the first figure, we could be fooled into thinking that there is no relationship up to around HFI = 0.4, until which it seems like an exponentional relationship. However, zooming in from HFI 0 to 0.4, we see that the confidence bands don't intersect at all with the red line, which is the expected value given no relationship. This relationship appears non-linear and possibly exponential, where the greatest intensity of observed red foxes occurs at high HFIs. This relationship was expected, as our dataset is not exhaustive but rather is crowdsourced, and naturally foxes are more likely to be noticed by humans in spaces with higher HFIs.

```{r}
plot(log(rho_HFI$rho))
```

If we plot the log of the rho, we get a line that could be reasonably interpreted as linear. 

### simple model
```{r, warning=F}
fitHFI <- ppm(parks_ppp ~ HFI,data=DATA)
fitHFI
```
```{r}
fitHFIexp <- ppm(parks_ppp~HFI + exp(HFI), data=DATA)
fitHFIexp
```
```{r}
AIC(fitHFI); AIC(fitHFIexp)
```

```{r}
plot(fitHFIexp, se = F, superimpose = F)
```


### Forest Cover

```{r warning=F}
plot(DATA$Forest, box = F, par(cex.main = 2), main = "Forest")
plot(parks_ppp, pch = 16, cex = 0.9, col = "green",use.marks = F, add = T)
```

### 1. To add : Add other covariates together - side by side

```{r}
#load the spatstat package
library(spatstat)


#Estimate Rho for Forest Cover
rho_elev <- rhohat(parks_ppp, DATA$Forest)

#Estimate Rho
#rho_grad <- rhohat(bei, bei.extra$grad)

#par(mfrow = c(1,2))
plot(rho_elev,
     main = "",
     xlab = "Forest cover")
#plot(rho_grad,
#     main = "",
#     xlab = "Gradient (degrees)")
```

There seems to be non-linear relationship between forest cover and number of red foxs observed. The observance increase with increase in forest cover at intermediate coverage and then it decreases.

Next is to observe if there is any correlation between the covariates (collinearity in the covariates dataset). This is necessary to avoid any identifiability issues in modeling the data.

### Elevation

```{r warning=F}
plot(DATA$Elevation, box = F, par(cex.main = 2), main = "Elevation")
plot(parks_ppp, pch = 16, cex = 0.9, col = "green",use.marks = F, add = T)
```


```{r}
#Estimate Rho for elevation
rho_elev <- rhohat(parks_ppp, DATA$Elevation)

#Plot Rho
par(mfrow = c(1,2))
plot(rho_elev,
     main = "",
     xlab = "Elevation")
plot(rho_elev,
     main = "",
     xlab = "Elevation", xlim = c(0,3000))

```

In the first figure, there seems to be no relationship but after taking a closer look we see that there is non-linear relationship. The relationship appears to be non-linear as the graph is showing diffrent results for different elevation and we cannot see any type of specific pattern from the same.

### Distance to Water

```{r warning=F}
plot(DATA$Dist_Water, box = F, par(cex.main = 2), main = "Distance from Water")
plot(parks_ppp, pch = 16, cex = 0.9, col = "green",use.marks = F, add = T)
```


```{r}
#Estimate Rho for water distance
rho_water <- rhohat(parks_ppp, DATA$Dist_Water)

#Plot Rho
plot(rho_water,
     main = "",
     xlab = "Distance from Water")

```

In the above figure, we see that there is non liner relationship.


### 2. Checking collinearity

```{r}
cor.im(DATA$Forest, DATA$HFI, DATA$Elevation, DATA$Dist_Water, use = "complete.obs")
```

We see that no covariate is strongly collinear with another, and so we can move on without taking so into account and treating the covariates as independent.

```{r}
# Viji's code from b4
#Check for collinearity
#x <- DATA$HFI
#y <- DATA$Forest
#Y<- solapply(x,y,scaletointerval.im)
#im.apply(Y, cor.im,na.rm=TRUE,fun.handles.na=TRUE, check=TRUE)

#FUNC <- function(x,y){
#  cor.im(x,y)
#}

#class(y)
```


```{r}
#plot(DATA$HFI$v ~ DATA$Forest$v,
#     xlab = "HFI",
#     ylab = "Forest",
#     pch = 16,
#     cex = 0.3,
#     col = "#046C9A")
```


### 3. Finalize and summarize about other two variables - elevation and water.

## Model Fitting
Try different models - linear and quadratic, do necessary anova and other tests for model selection and validation



### Model with Forest
```{r}
#Fit the PPP model
fit <- ppm(parks_ppp ~ Forest + I(Forest^2),data=DATA)
fit
```
All variables look significant.

```{r}
#Plot the model predictions
plot(fit,
     se = FALSE,
     superimpose = FALSE)

#Overlay the red fox locations
plot(parks_ppp,
     pch = 16,
     cex = 0.6,
     cols = "white",
     add = TRUE)
plot(parks_ppp,
     pch = 16,
     cex = 0.5,
     cols = "black",
     add = TRUE)
```
Does not look like a good fit for all points and also not easy to interpret.

### Model with Elevation
```{r}
#Fit the PPP model
fitElev <- ppm(parks_ppp ~ Elevation, data=DATA)
fitElev
```

```{r}
#Plot the model predictions
plot(fitElev,
     se = FALSE,
     superimpose = FALSE)

#Overlay the red fox locations
plot(parks_ppp,
     pch = 16,
     cex = 0.6,
     cols = "white",
     add = TRUE)
```

### Model with Distance to Water
```{r}
#Fit the PPP model
fitWater <- ppm(parks_ppp ~ Dist_Water, data=DATA)
fitWater
```
```{r}
#Plot the model predictions
plot(fitWater,
     se = FALSE,
     superimpose = FALSE)

#Overlay the red fox locations
plot(parks_ppp,
     pch = 16,
     cex = 0.6,
     cols = "white",
     add = TRUE)
```


Here Elevation is significant but Dist to Water is not significant. 

```{r}
AIC(fitHFI);AIC(fit);AIC(fitElev);AIC(fitWater)
```



### Analyze - linear+quad, AIC

### Validate if we need GAM - 5. linear vs gam - table: evaluate, AIC, visualize

# Results: Length: Describe your statistical findings. Tables and figures should be used throughout. Length: As long as necessary.

## Findings from EDA

## model: Tablulate observations -4. table to summarize models - linear+quad, AIC

## model: GAM - Table if necessary


# Discussion: Provide a brief summary of your findings. Length: ca. 1 page.

# References: Include references to all necessary literature.

1. Data: GBIF.org (09 April 2023) GBIF Occurrence Download  https://doi.org/10.15468/dl.p6tsaa
2. Research topics: https://cwf-fcf.org/en/resources/encyclopedias/fauna/mammals/red-fox.html
