---
title: "Red Foxes in BC: an Analysis of the Spatial Point Process"
author: "Nowshaba Durrani, Ricky Heinrich, Viji Rajagopalan"
date: "2023-04-09"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F,fig.width=8, fig.height=6, warning = F, cache = T, message = F)
```


```{r message=FALSE, include=F}
library(rgbif) #allows searching and retrieving data from GBIF
library(ggplot2) #use ggplot2 to add layer for visualization
library(sp) #Standardized Support for Spatial Vector Data
library(sf)
library(spatstat)
library(maptools)
```

# Introduction

```{r}
#occ_count() # occurance count for all the species in GBIF (Global Biodiversity Information Facility) - rgbif

redFox <- name_backbone(name="Vulpes vulpes")
redFoxList <- occ_data(taxonKey = redFox$speciesKey, hasCoordinate=TRUE, stateProvince='British Columbia', limit=2000)
mydata <- redFoxList$data
n_row <- nrow(redFoxList$data)
n_col <- ncol(redFoxList$data)
#n_row
#n_col
```



```{r}

load("BC_Covariates.Rda")

# Create a spatial points data frame from the longitude and latitude columns
coordinates <- mydata[,c("decimalLongitude", "decimalLatitude")]
dat.sp <- SpatialPointsDataFrame(c(mydata[,c('decimalLongitude','decimalLatitude')]), data = mydata)

# Set the current CRS
proj4string(dat.sp)<- CRS("+proj=longlat +datum=WGS84")

# Define the new CRS you want to transform to
new_crs <- CRS("+proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 
               +y_0=0 +datum=NAD83 +units=m +no_defs")

# Transform the data to the new CRS
data.sp_trans <- spTransform(dat.sp, new_crs)

#data_transformed
#data.sp_trans

#plot(data.sp_trans, main = "Locations in BC", cex = 0.8, col ="blue")
```

For our Data 589 project, we have selected Red Fox (Scientific Name - Vulpes Vulpes) to do the analysis. In the GBIF database they have approximately, 610,958+ georeferences records for this species around the world, however for this project we have selected to do the analysis of the occurance of Red Fox in BC only. So with the above function we have fetched the information for British Columbia only in `r n_col` columns and `r n_row` number of entries.

```{r warning=FALSE, fig.cap = "Occurence of Red Foxes in BC"}
parks_ppp <- ppp(x = data.sp_trans@coords[,1], # X coordinates
                    y = data.sp_trans@coords[,2], # Y coordinates
                    window = as.owin( DATA[["Window"]]),# Observation window
                    )

col_pal <- c("maroon")
plot(parks_ppp,
     main = "",
     cex = 0.9,
     col ="white",
     border = 3,
     cols = col_pal,
     par(bg = "grey90",cex.main = 1.6))

```

Here we have plotted all the occurrences of Red Fox in the BC region and we can see that the species are scattered in the region specially in the upper and middle part of the province. Now we will be exploring what is contributing to the occurrences of the species in the specific places based on various factors like elevation, close to water bodies, forests, human habitats, etc.

# Methods

Briefly describe the data and what variables are included. Provide a detailed description of the analytical workflow that was applied to the data, citing any relevant literature and statistical packages employed. There should be enough information that anyone can reproduce the workflow if they had access to the data. Length: As long as necessary.

The data comes from the Global Biodiversity Information Facility (GBIF) databases. We used the package `rgbif` to access the 'Vulpes Vulpes' data from R directly, sorting by instances occuring in BC. We've extracted the longitude and latitude data from this, and converted it appropriately using the `sp` package. 

Our second source of data contained the BC Window object, as well as possible covariate data: elevation, forest cover, Human Footprint Index (HFI) and distance to water.

We used the package `spatstat` to build a `ppp` object with the converted coordinates of the Red Fox locations from the GBIF data and the window from our second data source. 

To conduct first moment analysis, we used functions from the aforementioned `spatstat` package. We did a quadrat test as well as hotspot analysis to gain insight into the homogeneity assumption of the point process.

For second moment analysis, we looked into Ripley's K-function and pair correlation function using functions from `spatstat`. This provides us with insight into possible clustering tendencies of the point process.

Next we looked into the relationship of the intensity with each covariate. 


# Results

## Exploratory Analysis (First Moment till Covariates & basic individual models)

## First Moment Analysis

We start with investigating whether the occurence of red foxes in BC seems homogeneous, as it will inform our steps to define the intensity. We have conducted a quadrat test of homogeneity with both 5 x 5 and 10 x 10 quadrats. These quadrats are shown in Figure 2, where we can visually tell that the intensity in each quadrats are not the same. The quadrat test for both the 5 x 5 and the 10 x 10 quadrats provide a p-value of 2.2e-16, confirming that the varied intensities are not due to chance alone, but rather due to an inhomogeneous point process. 


```{r}
#Split into a 5 by 5 quadrat and count points
Q5 <- quadratcount(parks_ppp,
                  nx = 5,
                  ny = 5)

Q10 <- quadratcount(parks_ppp,
                  nx = 10,
                  ny = 10)
```

```{r, fig.cap = "Quadrat counts of Red Fox occurences, left 5x5, right 10x10", eval=F}

#Plot the output 
par(mfrow=c(1,2))
plot(parks_ppp,
     pch = 12,
     cex = 0.5,
     cols = "#046C9A",
     main = "")
plot(Q5, cex = 1, col = "red", add = T)
plot(parks_ppp,
     pch = 12,
     cex = 0.5,
     cols = "#046C9A",
     main = "")
plot(Q10, cex = 1, col = "red", add = T)
```

```{r, fig.cap = "Intensity of Quadrat counts of Red Fox occurences, left 5x5, right 10x10"}
#Plot the output 
par(mfrow=c(1,2))
plot(intensity(Q5, image = T),
     main = "")
plot(parks_ppp,
     pch = 12,
     cex = 0.5,
     cols = "#046C9A", add = T)
plot(intensity(Q10, image = T), main = "" )
plot(parks_ppp,
     pch = 12,
     cex = 0.5,
     cols = "#046C9A",
     add = T)
```


```{r warning=FALSE, eval=F}
#Quadrat test of homogeneity 
quadrat.test(Q10)
```



As the next step, we investigate analyze for any hot spots in the occurences of red foxes. In Figure 3, we can see that hotspots appear scattered around the province. It seems like the highest densities of red fox occurences are more inland, but spread across the province.

```{r fig.cap = "Hotspot of Red Foxes"}
# Estimate R
R <- bw.ppl(parks_ppp)

#Calculate test statistic
LR <- scanLRTS(parks_ppp, r = R)

#Plot the output 
plot(LR, main = "")
plot(parks_ppp[["window"]], border = "white", add = T)

#Compute local p-values
pvals <- eval.im(pchisq(LR,
                        df = 1,
                        lower.tail = FALSE))

#Plot the output
#plot(pvals, main = "Local p-values")
#plot(parks_ppp[["window"]],  add = T)
```


## 2nd Moment Analysis

Ripley's K-function provides information on whether there are significant deviations from independence between points. Taking into account that the intensity of red fox occurences appear inhomogeneous, we can see in Figure 4 that there is some evidence of clustering up to a certain distance, as the black line, indicating the observed data, is separate from the 95% confidence bands of the values expected with no clustering. This suggests that the relationship between points may be due to effects between points rather than relationship with covariates. [CHECK THIS CLAIM ?] 


```{r fig.cap="Ripley's K function with border correction assuming homogeneity", eval=F}
E_fox_homo <- envelope(parks_ppp,
                  Kest,
                  correction="border",
                  rank = 1,
                  nsim = 19, # aka alpha of 0.05
                  fix.n = T,
                  verbose = F)
plot(E_fox_homo, lwd = 2, main = "")

# Assuming homogeneity in the point process, we see that the actual occurence lines appear clustered, as the black line does not overlap with the expected red line confidence intervals (significance level of 0.05).
```



```{r fig.cap="Ripley's K function with border correction assuming inhomogeneity"}
E_fox <- envelope(parks_ppp,
                  Kinhom,
                  correction="border",
                  rank = 1,
                  nsim = 19, # aka alpha of 0.05
                  fix.n = T,
                  verbose = F)
plot(E_fox, lwd = 2, main = "")
```


To get a sense of the distances for which clustering occurs, we used the pair correlation function. Figure 5 shows evidence for clustering at distances smaller than around 23 000m, or 23km but after that the observed values are not significantly different that those expected from a random spatial process.


```{r fig.cap="Pair correlation function assuming inhomogeneity"}
# Estimate the g function
#pcf_fox <- pcfinhom(parks_ppp) # assumes inhomogeneity

# estimate a strickly pos density
lambda_pos <- density(parks_ppp,sigma=bw.ppl,positive=TRUE)
# estimating with bootstraped ci
pcf_fox <- envelope(parks_ppp, pcfinhom, simulate = expression(rpoispp(lambda_pos)),rank = 1, nsim = 19,verbose = F)
# Default plot method
#plot(pcf_fox, lwd = 2)

# visualise the results
plot(pcf_fox, main = "")
#plot(pcf_fox,theo ~ r,ylim = c(0,20),main = "",col = "grey70",lwd = 2,lty = "dashed")
#plot(pcf_fox,iso ~ r, col = c("#046C9A"),lwd = 2, add = T)
```


## Relationship with Covariates 

Our data includes 4 covariates which we are exploring: the elevation, the forest cover, the human footprint inventory (HFI), and the distance to water. Given our research questions, we were expecting HFI and forest cover to have a relationship, but we have also investigated the two other covariates.


```{r, warning=F, fig.cap="Red Fox plotting in various covariets"}
par(mfrow=c(2,2))

plot(DATA$HFI, box = F, par(cex.main = 1), main = "HFI")
plot(parks_ppp,
pch = 16,
cex = 0.6,
cols = "white",
add = TRUE)
plot(parks_ppp,
pch = 16,
cex = 0.5,
cols = "black",
add = TRUE)

plot(DATA$Forest, box = F, par(cex.main = 1), main = "Forest")
plot(parks_ppp,
pch = 16,
cex = 0.6,
cols = "white",
add = TRUE)
plot(parks_ppp,
pch = 16,
cex = 0.5,
cols = "black",
add = TRUE)

plot(DATA$Elevation, box = F,  main = "Elevation")
plot(parks_ppp,
pch = 16,
cex = 0.6,
cols = "white",
add = TRUE)
plot(parks_ppp,
pch = 16,
cex = 0.5,
cols = "black",
add = TRUE)

plot(DATA$Dist_Water, box = F, par(cex.main = 2), main = "Distance from Water")
plot(parks_ppp,
pch = 16,
cex = 0.6,
cols = "white",
add = TRUE)
plot(parks_ppp,
pch = 16,
cex = 0.5,
cols = "black",
add = TRUE)
```

In Figure 6, we can see the observed data over the values of the covariates, and get a first idea of possible relationships. We see the red fox is seen more in the averagely densed population area and near highly densed forest area. In case of elevation, red foxes are seen in moderately elevated area and where the distance to water is low to medium. 

### Smoothing Estimate of the 4 Covariates Transformation

```{r}

par(mfrow=c(3,3))

#Estimate Rho for HFI
rho_HFI <- rhohat(parks_ppp, DATA$HFI)
plot(rho_HFI,
     main = "",
     xlab = "HFI")
plot(rho_HFI,
     main = "",
     xlab = "HFI", xlim = c(0,0.8))

#Estimate Rho for Forest Cover
rho_forest <- rhohat(parks_ppp, DATA$Forest)
plot(rho_forest,
     main = "",
     xlab = "Forest cover")

#Estimate Rho for elevation
rho_elev <- rhohat(parks_ppp, DATA$Elevation)
#plot(rho_elev,main = "",xlab = "Elevation")
plot(rho_elev,
     main = "",
     xlab = "Elevation", xlim = c(0,max(DATA$Elevation)))

#Estimate Rho for water distance
rho_water <- rhohat(parks_ppp, DATA$Dist_Water)
plot(rho_water,
     main = "",
     xlab = "Distance from Water")
```

In the first figure for HFI, we could be fooled into thinking that there is no relationship up to around HFI = 0.4, until which it seems like an exponential relationship. However, zooming in from HFI 0 to 0.8, we see that the confidence bands don't intersect at all with the red line, which is the expected value given no relationship. This relationship appears non-linear and possibly exponential, where the greatest intensity of observed red foxes occurs at high HFIs. This relationship was expected, as our dataset is not exhaustive but rather is crowdsourced, and naturally foxes are more likely to be observed by humans in spaces with higher HFIs.

Regarding forest cover we can observe that there seems to be non-linear relationship between forest cover and number of red foxes observed. The observance increase with increase in forest cover at intermediate coverage and then it decreases. 

Regarding the elevation, we see that there is non-linear relationship between elevation and the occurance of red foxes. The relationship appears to be non-linear as the graph is showing different results for different elevation and we cannot see any type of specific pattern from the same. 

In case of Distance to Water, we don't observe a significant deviation in observed red foxes than expected by chance.


### Fit models for the covariets

```{r, warning=F}
#Fit the PPP model for HFI
fitHFI <- ppm(parks_ppp ~ HFI,data=DATA)
fitHFI
fitHFIexp <- ppm(parks_ppp~HFI + exp(HFI), data=DATA)
fitHFIexp

#Fit the PPP model for forest
fit <- ppm(parks_ppp ~ Forest + I(Forest^2),data=DATA)
fit

#Fit the PPP model for Elevation
fitElev <- ppm(parks_ppp ~ Elevation, data=DATA)
fitElev

#Fit the PPP model for Distance to water
fitWater <- ppm(parks_ppp ~ Dist_Water, data=DATA)
fitWater
```
We have fitted 6 models and we came to observe that HFI, exp(HFI), Forest, I(Forest^2) and elevation seems to be highly significant however Distance to Water seems to be in-significant for the occurrence of red foxes in the BC area.

```{r}
AIC(fitHFI); AIC(fitHFIexp); AIC(fit); AIC(fitElev); AIC(fitWater)
```

## Plot the fitted models

```{r}

par(mfrow=c(2,2))

#Plot the model predictions for HFI(Exp) & overlay the red fox locations
plot(fitHFIexp, se = F, superimpose = F, main="Fitted Model for HFI(Exp)")
plot(parks_ppp,
     pch = 16,
     cex = 0.6,
     cols = "white",
     add = TRUE)

#Plot the model predictions for Forest & overlay the red fox locations
plot(fit, se = F, superimpose = F, main="Fitted Model for Forest")
plot(parks_ppp,
     pch = 16,
     cex = 0.6,
     cols = "white",
     add = TRUE)

#Plot the model predictions for Elevation & overlay the red fox locations
plot(fitElev, se = F, superimpose = F, main="Fitted Model for Elevation")
plot(parks_ppp,
     pch = 16,
     cex = 0.6,
     cols = "white",
     add = TRUE)

#Plot the model predictions for Distance to Water & overlay the red fox locations
plot(fitWater, se = FALSE, superimpose = FALSE, main="Fitted Model for Distance to Water)")
plot(parks_ppp,
     pch = 16,
     cex = 0.6,
     cols = "white",
     add = TRUE)
```

Does not look like a good fit for all points in forest and also not easy to interpret. Here Elevation is significant but Dist to Water is not significant. 


### 2. Checking collinearity

```{r}
cor.im(DATA$Forest, DATA$HFI, DATA$Elevation, DATA$Dist_Water, use = "complete.obs")
```

We see that no covariate is strongly collinear with another, and so we can move on without taking so into account and treating the covariates as independent.


```{r}
#plot(DATA$HFI$v ~ DATA$Forest$v,
#     xlab = "HFI",
#     ylab = "Forest",
#     pch = 16,
#     cex = 0.3,
#     col = "#046C9A")
```


### 3. Finalize and summarize about other two variables - elevation and water.
Elevation is significant...so that is included in the model.

##End of EDA and covariates analysis

## Model Fitting
Try different models - linear and quadratic, do necessary anova and other tests for model selection and validation

```{r}
#Fit the PPP model
fit_red <- ppm(parks_ppp ~ Forest + I(Forest^2) + HFI + I(HFI^2)+ Elevation + I(Elevation^2), data = DATA)

fit_red
```
Forest related variables are not highly significant when compared to HFI and elevation but
still significant. So we retain them in the model.

```{r}
#Plot the model predictions
plot(fit_red,
     se = FALSE,
     superimpose = FALSE,log=TRUE,n=500)

#Overlay the red fox locations
plot(parks_ppp, pch = 16, cex = 0.9, col = "green",use.marks = F, add = T)

```
```{r}
#Calculate the residuals
#res <- residuals(fit_red)

#Visualise
#plot(res, cols = "transparent",)

#Due to error with residuals function for this data, diagnose.ppm is used instead
diagnose.ppm(fit_red)

```

```{r}
#Fit the PPP model
fit_red2 <- ppm(parks_ppp ~ HFI + I(HFI^2)+ Elevation + I(Elevation^2), data = DATA)

fit_red2
```

```{r}
#Plot the model predictions
plot(fit_red2,
     se = FALSE,
     superimpose = FALSE,log=TRUE,n=500)

#Overlay the red fox locations
plot(parks_ppp, pch = 16, cex = 0.9, col = "green",use.marks = F, add = T)
```

```{r}
#AIC(fitHFI); AIC(fitHFIexp); AIC(fitHFIquad); AIC(fit_for); AIC(fit_red)
AIC(fit_red); AIC(fit_red2)
```

### Validate if we need GAM - 5. linear vs gam - table: evaluate, AIC, visualize

```{r}
#Run the quadrat test
quadrat.test(fit_red2, nx = 5, ny = 5)
```



```{r}
#Calculate the relative intensity as a function of elevation
#rh_elev <- rhohat(fit_red2, DATA$Elevation)

#Calculate the relative intensity as a function of forest
#rh_for <- rhohat(fit_red, DATA$Forest)

#Calculate the relative intensity as a function of forest
#rh_HFI <- rhohat(fit_red, DATA$HFI)

#Side by side plotting
#par(mfrow = c(1,2))
#plot(rh_elev,
#     legend = FALSE,
#     main = "",
#     xlab = "Elevation (m)")
#plot(rh_for,
#     legend = FALSE,
#     main = "",
#     xlab = "Forest")
#plot(rh_HFI,
#     legend = FALSE,
#     main = "",
#     xlab = "HFI")
```

Rho plots do not run due to NA error.
     
# using above, check the intensity.

##Calculate partial residuals only for 2 covariates


```{r}
#Calculate the partial residuals as a function of elevation
par_res_elev <- parres(fit_red2, "Elevation")

#Calculate the relative intensity as a function of HFI
par_res_HFI <- parres(fit_red2, "HFI")

#Side by side plotting
par(mfrow = c(1,2))
plot(par_res_elev,
     legend = FALSE,
     lwd = 2,
     main = "",
     xlab = "Elevation (m)")
plot(par_res_HFI,
     legend = FALSE,
     lwd = 2,
     main = "",
     xlab = "HFI")
```


```{r}
#Mean HFI
E_hfi <- mean(DATA$HFI)

#Elevational effect on lambda at mean HFI
elev_effect <- effectfun(fit_red2, "Elevation", HFI = E_hfi, se.fit = T)


#Mean elevation
E_elev <- mean(DATA$Elevation)

#HFI effect on lambda at mean elevation
hfi_effect <- effectfun(fit_red2, "HFI", Elevation = E_elev, se.fit = T)

#Side by side plotting
par(mfrow = c(1,2))
#Plot the elevation effect 
plot(elev_effect,
     legend = FALSE,
     main = "Elevational effect at mean HFI")

#Plot the slope effect 
plot(hfi_effect,
     legend = FALSE,
     main = "Effect of HFI at mean elevation")
```


```{r}
#Plot the model predictions
plot(fit_red2,
     se = FALSE,
     superimpose = FALSE,log=TRUE,n=500,
     main = "Estimated Red Fox intensity")

#Overlay the red fox locations
plot(parks_ppp,
     pch = 16,
     cex = 0.6,
     cols = "white",
     add = TRUE)
plot(parks_ppp,
     pch = 16,
     cex = 0.5,
     cols = "black",
     add = TRUE)
```

```{r}
diagnose.ppm(fit_red2)
```

```{r}
library(splines)

#Fit the PPP model
fit_smooth <- ppm(parks_ppp ~ bs(Elevation,12) + bs(HFI, 5), data = DATA, use.gam = TRUE)

fit_smooth
```
```{r}
#Delta AIC
AIC(fit_red2) - AIC(fit_smooth)
AIC(fit_smooth)
```
```{r}
#Calculate the partial residuals as a function of elevation
par_res_elev <- parres(fit_smooth, "Elevation")

#Calculate the relative intensity as a function of HFI
par_res_HFI <- parres(fit_smooth, "HFI")

#Side by side plotting
par(mfrow = c(1,2))
plot(par_res_elev,
     legend = FALSE,
     lwd = 2,
     main = "",
     xlab = "Elevation (m)")
plot(par_res_HFI,
     legend = FALSE,
     lwd = 2,
     main = "",
     xlab = "HFI")
```
Higher powers for elevation - error with convergence


```{r}
#AIC(fitHFI);AIC(fit);AIC(fitElev);AIC(fitWater)
```
```{r}
AIC(fit_red); AIC(fit_red2); AIC(fit_smooth)
```

```{r}
#Likelihood ratio test
anova(fit_red2,fit_red, test = "LRT")
```




## model: Tablulate observations -4. table to summarize models - linear+quad, AIC

## model: GAM - Table if necessary


# Discussion: Provide a brief summary of your findings. Length: ca. 1 page.

# References: Include references to all necessary literature.

1. Data: GBIF.org (09 April 2023) GBIF Occurrence Download  https://doi.org/10.15468/dl.p6tsaa
2. Research topics: https://cwf-fcf.org/en/resources/encyclopedias/fauna/mammals/red-fox.html
